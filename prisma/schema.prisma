// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  TERMINATED
}

enum Gender {
  MALE
  FEMALE
}

enum LeaveStatus {
  APPROVED
  PENDING
  REJECTED
  CANCELLED
}

enum SalaryComponentType {
  EARNING
  DEDUCTION
}

enum PayrollFrequency {
  MONTHLY // thang
  WEEKLY // tuan
  DAILY // ngay
  BIMONTHLY // 2 thang 1 lan
  FORNIGHTLY // 2 tuan 1 lan
}


model Employee {
  id Int @id @default(autoincrement())
  firstName String 
  lastName String 
  dateOfBirth DateTime
  gender Gender
  image String?
  passport String?
  phone String?
  address String?
  employmentType EmploymentType @default(FULL_TIME)
  createdAt DateTime @default(now())
  contractEndDate DateTime?
  dateOfRetirement DateTime?
  ctc Decimal? @db.Decimal(10,2) @default(0) // Cost to Company

  departmentId Int?
  department Department? @relation("DepartmentEmployees",fields: [departmentId], references: [id])
  designationId Int
  designation Designation @relation(fields: [designationId], references: [id])
  managerId Int?
  manager Employee? @relation("ManagerToDirects", fields: [managerId], references: [id])
  directReports Employee[]      @relation("ManagerToDirects")
  user User?
  leaderDepartment Department?
  leaves Leave[]
  leaveApproved Leave[] @relation("LeaveApprover")
  leaveAllocations LeaveAllocation[]
  shiftAssignment ShiftAssignment[]
}

model Department {
  id Int @id @default(autoincrement())
  name String @unique
  employees Employee[] @relation("DepartmentEmployees")
  leaderId Int? @unique
  leader Employee? @relation(fields: [leaderId], references: [id])
  createdAt DateTime @default(now())
  status Boolean @default(true)
}


model Designation {
  id Int @id @default(autoincrement())
  title String // "Senior Developer"
  employees Employee[]
}


model User {
  id Int @id @default(autoincrement())
  email String @unique
  username String?
  password String
  employeeId Int @unique
  employee Employee @relation(fields: [employeeId], references: [id])
  roleId Int
  role Role @relation(fields: [roleId], references: [id])
  createdAt DateTime @default(now())
}

model Role {
  id Int @id @default(autoincrement())
  name String
  users User[]
  status Boolean @default(true)
}


model Leave {
  id Int @id @default(autoincrement())
  employee Employee @relation(fields: [employeeId], references: [id])
  employeeId Int
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])
  leaveTypeId Int
  reason String?
  fromDate DateTime
  toDate DateTime
  isHalfDay Boolean?
  halfDayDate DateTime?
  approver Employee? @relation("LeaveApprover", fields: [approverId], references: [id])
  approverId Int?
  status LeaveStatus @default(PENDING)
}

model LeaveType {
  id Int @id @default(autoincrement())
  name String
  leaves Leave[]
  allocations LeaveAllocation[]
  createdAt DateTime @default(now())
}

model LeaveAllocation {
  id Int @id @default(autoincrement())
  fromDate DateTime
  toDate DateTime
  newLeavesAllocated Int 
  employeeId  Int
  employee Employee @relation(fields: [employeeId], references: [id])
  leaveTypeId Int
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])
}

// Todo - Payroll
model SalaryComponent {
  id Int @id @default(autoincrement())
  name String
  isTaxable Boolean @default(false)
  type SalaryComponentType 
  description String?
  status Boolean @default(true)
  salaryStructure SalaryStructureOnSalaryComponent[]
}

model SalaryStructure {
  id Int @id @default(autoincrement())
  name String
  frequency PayrollFrequency @default(MONTHLY)
  salaryComponent SalaryStructureOnSalaryComponent[]
}

model SalaryStructureOnSalaryComponent {
  salaryComponentId Int 
  salaryComponent SalaryComponent @relation(fields: [salaryComponentId], references: [id])
  salaryStructureId Int
  salaryStructure SalaryStructure @relation(fields: [salaryStructureId], references: [id]) 
  amount Decimal? @db.Decimal(10,2) @default(0)

 @@id([salaryComponentId, salaryStructureId])
}

// todo payroll

model ShiftType {
  id Int @id @default(autoincrement())
  name String
  startTime String 
  endTime String
  shiftAssignment ShiftAssignment[]
}

model ShiftAssignment {
  id Int @id @default(autoincrement())
  name String
  date DateTime @db.Date
  shiftId Int
  shift ShiftType @relation(fields: [shiftId], references: [id]) 
  employeeId Int 
  employee Employee @relation(fields: [employeeId], references: [id])
  attendance Attendance[]
  status Boolean @default(true)
}

model Attendance {
  id          String   @id @default(uuid())
  
  // Liên kết với ca làm việc cụ thể (Để biết đi muộn/về sớm so với ca nào)
  shiftAssignmentId Int @unique
  shiftAssignment   ShiftAssignment @relation(fields: [shiftAssignmentId], references: [id])

  // Thời gian thực tế
  checkInTime       DateTime
  checkOutTime      DateTime? // Nullable vì lúc check-in chưa có giờ ra

  // Địa điểm/Bằng chứng (Quan trọng để chống gian lận)
  checkInLocation   Json?     // Lưu {lat: 10.123, long: 106.456, accuracy: 10}
  checkInImage      String?   // URL ảnh selfie (nếu dùng AI Face Check)
  deviceInfo        String?   // User-Agent hoặc Device ID

  // Kết quả tính toán (Backend tự tính)
  lateDuration      Int       @default(0) // Số phút đi muộn
  earlyLeaveDuration Int      @default(0) // Số phút về sớm
  status            AttendanceStatus @default(PRESENT)
}

enum AttendanceStatus {
  PRESENT
  LATE
  EARLY_LEAVE
  ABSENT      // Tự động đánh nếu hết ngày mà không thấy check-in
}





